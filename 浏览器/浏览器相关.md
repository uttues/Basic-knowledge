# EventLoop相关

> ---
>
> JavaScript中分为**同步任务跟异步任务**。
>
> * 同步任务在**主线程**上运行，形成一个**执行栈**。
> * 而在主线程之外，还有**事件触发线程、定时器触发线程**，当某一个事件|定时器被触发时该线程会把对应的回调函数添加到**待处理队列**中，等待主线程处理。待处理队列有两个，分别是**宏任务队列跟微任务队列**。也就是说，当异步任务完成时，就会根据宏任务/微任务之分，将回调函数放到对应的任务队列中。
>
> ---

**事件循环**：

1、一旦执行栈为空，EventLoop就会**执行当前所有微任务**，清空微任务队列

2、微任务队列清空后，会在**宏任务队列中取下第一项宏任务**放入执行栈中执行，循环第一步



## 宏任务&微任务

JS中分为两种任务类型：**宏任务`macrotask`（task）**和**微任务 `microtask`（job）**

**macrotask：**可以理解是每次**执行栈执行的代码**就是一个宏任务（包括每次从**宏任务队列中获取一个回调并放到执行栈中执行**）

**microtask**：当前 **宏任务执行结束后立即执行的任务**（当前所有微任务都会执行）

- **macrotask**：**主代码块，setTimeout，setInterval等**
- **microtask：Promise，process.nextTick等**

```
task => process.nextTick => Promise => 渲染 => task  ……
```





# 浏览器的架构（进程、线程）

## 进程、线程

**进程**：是CPU分配资源的最小单位，是能**拥有资源（内存）和独立运行的最小单位**

**线程**：线程是**建立在进程的基础**上的一次程序运行单位，是**CPU调度**的最小单位。

* 线程**不能单独存在**，由进程来启动和管理

![image-20200721170928251](D:\Uttues\Basic-knowledge\浏览器\浏览器相关.assets\image-20200721170928251.png)

### 进程和线程之间的关系

1、进程中的**任意一线程执行出错**，都会导致整个进程的**崩溃**。

2、线程之间**共享进程中的数据**，可以对进程的公共数据进行读写操作

3、当一个进程关闭之后，操作系统会**回收进程所占用的内存**（即使有些线程使用不当，存在内存泄漏也都能回收）

4、**进程之间的内容相互隔离**，来保护操作系统中的进程互不干扰

---

> * IE 浏览器 - 多插件 - 容易内容泄露 - 内存占用越来越多 - 关闭页面则可回收
>
> * 进程只能访问自己的数据，必要时通过**进程间通信（IPC）**来进行数据通信
>
> * 一个进程的**崩溃 | 挂起** 不会影响到其他进程





## 过去的单进程浏览器

**单进程浏览器**：浏览器的所有功能模块都是运行在同一个进程里，包含了网络、插件、JavaScript 运行环境、渲染引擎和页面等。

![img](https://static001.geekbang.org/resource/image/6d/ca/6ddad2419b049b0eb2a8036f3dfff1ca.png)

---

**缺点**

* **不稳定**：**局部崩溃**会引起**整个浏览器的崩溃**（插件容易崩溃，渲染引擎模块执行Javascript时也容易崩溃）
* **不流畅**
  * **页面的渲染模块、JavaScript 执行环境以及插件** 运行在**同一个线程**中的。某一个任务执行时间过长会独占整个线程，页面没有机会占用线程执行任务，从而导致整个浏览器失去响应，变卡顿。
  * **页面的内存泄漏**也会使得单进程浏览器变得越来越慢，因为有时关闭页面可能出现内存无法回收的情况。

* **不安全**
  * **恶意插件**：用 C/C++ 等代码编写的**插件**可以获取操作系统的资源，存在安全隐患
  * **恶意脚本：** 恶意脚本可以利用**浏览器的漏洞**入侵到浏览器进程内部，甚至穿透浏览器攻击操作系统



## 目前的多进程浏览器

- **浏览器主进程**： 主要负责**界面显示、用户交互、子进程管理、文件储存**等功能
- **GPU进程**：网页、Chrome 的 UI 界面选择采用 **GPU 来绘制**，GPU成为普遍需求
- **网络进程**：面向渲染进程和浏览器进程等**提供网络下载功能**
- **渲染进程（浏览器内核）**：运行在**安全沙箱**中；负责把 HTML、JavaScript、CSS、图片等资源解析为可以显示、交互的页面
- **插件进程**：因为插件易崩溃，所以单独为插件进程来隔离，避免影响浏览器（**部分系统支持安全沙箱**）

![image-20200721193124028](D:\Uttues\Basic-knowledge\浏览器\浏览器相关.assets\image-20200721193124028.png)



### 渲染进程（浏览器内核）

浏览器中**默认每个Tab页面**都有一个**浏览器渲染进程（浏览器内核）**，用于**页面渲染，JS脚本执行，事件处理**等【多线程】

* **GUI渲染线程：**负责浏览器的渲染流程，解析 HTML、CSS，构建 DOM 树和 RenderObject 树，布局和绘制等
* **JS引擎线程（V8引擎|JS内核）**：处理Javascript脚本，等待任务队列中的任务到来**【单线程】**
* **事件触发线程**：控制**事件循环**，执行setTimeOut、鼠标点击时，**将对应事件添加到事件线程中**。当**事件被触发**时，将回调函数添加到 **宏任务|微任务队列**中
* **定时触发器线程**：负责setTimeout、setInterval**计时**（JS是单线程，阻塞会影响计时的准确），计时完成由事件触发线程添加回调到**宏任务队列**中
* **异步http请求线程**：当检测到xhr状态变更时，产生对应的状态变更事件（事件触发线程处理回调）



### 渲染进程如何与其他进程配合？

1. **在沙箱中运行的渲染进程无法发送网络请求的**，必须通过**进程间通信**，将请求传递给**浏览器主进程**，浏览器主进程交给**网络进程**来处理
2. **网络进程**获取网络资源后，**对响应内容进行解析**（检查字段判断是否跨域等等），检查无误则通过 IPC 将资源提交给**浏览器主进程**
3. **浏览器主进程 **通过 IPC 将资源传递给**渲染进程**
4. **渲染进程**会对资源进行解析、绘制等操作，最终渲染合成为一幅图片（并不负责将图片显示到界面上）
5. **渲染进程**将最终生成的图片提交给浏览器内核模块，由**浏览器内核模块**负责图片的显示

> （为什么渲染进程不请求网络资源？为什么渲染进程不显示图片？）



### 多进程浏览器如何改进单进程浏览器的缺陷

**不稳定** => **进程隔离**，单个页面、插件的崩溃不会导致整个浏览器崩溃

**不流畅** => 即使Javascript阻塞了某一个渲染进程，也**不会影响浏览器和其他页面**（依然流畅）

​             => 关闭页面，相当于关闭渲染进程，所占用的内存都会被系统回收（解决上述**页面内存泄漏问题**）

**不安全** => 可以将插件进程和渲染进程**运行在安全沙箱中**，即使是恶意程序也无法突破沙箱**直接攻击系统**（！！）



### 多进程浏览器的缺陷

* **更高的资源占用**：每个进程都会包含**公共基础结构的副本（如 JavaScript 运行环境）**，意味着多进程浏览器会消耗更多的内存资源
* **更复杂的体系架构**：浏览器各模块之间耦合性高、扩展性差等问题，会导致现在的架构已经很难适应新的需求了

> 目前还没有解决~ 漫长的迭代过程：面向服务架构（SOA）



### 其他进程模块

由于**渲染进程需要安全沙箱的保护**，因此需要把在渲染进程内部涉及到**和系统交互的功能**都转移到**其他进程模块**中去实现

**1、文件储存**

* 存储 Cookie 数据的读写
* 缓存文件的读取

> 浏览器主进程会维护 Cookie 数据库，当渲染进程通过 JavaScript 来读取 Cookie 时，渲染进程会通过 IPC 将读取 Cookie 的信息发送给浏览器主进程，浏览器主进程读取 Cookie 之后再将内容返回给渲染进程。

**2、网络访问**

网络进程除了发出请求，接受响应之外，还接管了相关检查拦截功能

* 在处理 URL 请求之前，**会检查渲染进程是否有权限请求该 URL**，比如检查 XMLHttpRequest 或者 Fetch 是否是跨站点请求
* **检测 HTTPS 的站点中是否包含了 HTTP 的请求**

**3、用户交互**

渲染进程内部是**无法直接操作 窗口句柄 **的，这是为了**限制渲染进程监控到用户的输入事件**（恶意脚本读取用户输入密码）

* 渲染进程需要**渲染出位图**，交给**浏览器主进程**显示到屏幕上（GPU进程）
* 操作系统将用户的输入事件**传递给浏览器主进程**，浏览器主进程再根据当前浏览器界面的状态来判断如何调度这些事件：
  * 如果当前焦点位于**浏览器地址栏**中，则输入事件会在浏览器主进程内部处理
  * 如果当前焦点在**页面的区域**内，则浏览器主进程会将输入事件转发给渲染进程。





## 浏览器架构如何影响操作系统安全

#### 单进程浏览器 & 浏览器漏洞

**浏览器本身的漏洞**是**单进程浏览器**的主要安全问题，其中最常见的攻击方式是利用**缓冲区溢出**

* 因为**黑客注入的恶意脚本**跟浏览器内核**运行在同一个进程中**，可以**利用漏洞对浏览器、OS实施攻击**
  * **入侵到浏览器进程内部**，读取和修改浏览器进程内部的任意内容
  * **穿透浏览器**，对用户的**操作系统**执行恶意操作（安装恶意软件、监听用户键盘输入信息、读取硬盘文件内容等）
* **单进程浏览器**需要频繁访问或者修改操作系统的数据，**无法用安全沙箱**来保护

---

> **通过浏览器漏洞进行的攻击**不同于XSS攻击：XSS **无法对操作系统进行攻击**，只是将恶意脚本注入到页面中，窃取数据



#### 多进程浏览器 & 安全沙箱

**思想：**

* 在**安全沙箱**里运行渲染进程，从而**隔离渲染进程与操作系统**，渲染进程**无法访问|修改操作系统中的数据**（恶意脚本也不能）
* 在**浏览器内核**中实现**与操作系统交互**的功能。通过**进程间通信（IPC）**实现浏览器内核与渲染进程的交互，从而**满足渲染进程访问系统资源的需求**

---

> ##### 问1：为什么要在安全沙箱里运行渲染进程？
>
> * 因为渲染进程中运行着**网络获取的资源**（不安全，不可信），可能会存在一些**恶意代码**会利用**浏览器漏洞**对系统进行攻击
>
> ##### 问2：什么是安全沙箱？
>
> * 浏览器中的安全沙箱是利用**操作系统提供的安全技术**，其**最小保护单位是进程**
> * 因为**单进程浏览器**需要**频繁访问或者修改操作系统的数据**，所以无法运行在安全沙箱中

---



### Chrome的站点隔离

**过去：**一个标签页为一个渲染进程

**问题：**一个标签页中可能包含了多个不同站点的 iframe => 不同站点的内容运行在同一个渲染进程中（恶意iframe利用系统漏洞实施攻击）

**现在：**将同一站点（包含了相同根域名、协议的地址）中相互关联的页面放到同一个渲染进程中执行，从而**将恶意的 iframe 隔离在恶意进程内部**，使得它**无法继续访问其他 iframe 进程的内容**



## JavaScript为什么是单线程的

作为浏览器脚本语言，JavaScript的主要用途是**与用户互动，以及操作DOM，这决定了它只能是单线程**，否则会带来很复杂的**同步问题**。比如，假定JavaScript同时有两个线程，一个线程在某个DOM节点上添加内容，另一个线程删除了这个节点，浏览器可能不知道要以哪个线程为准



## Web Worker（HTML5）

为了利用**多核CPU**的计算能力，**HTML5**提出Web Worker标准，**允许JavaScript脚本创建多个线程，但是子线程完全受主线程控制，且不得操作DOM**。

所以，这个新标准并没有改变JavaScript单线程的本质。



